
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://www.ovn.org/ovn-kubernetes/design/shared_gw_dgp/">
      
      
      
      
      <link rel="icon" href="../../images/ovn-inside-k8s.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.10">
    
    
      
        <title>Enable Node-Local Services Access in Shared Gateway Mode - OVN Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e359304.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#enable-node-local-services-access-in-shared-gateway-mode" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OVN Kubernetes" class="md-header__button md-logo" aria-label="OVN Kubernetes" data-md-component="logo">
      
  <img src="../../images/ovn-inside-k8s.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OVN Kubernetes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Enable Node-Local Services Access in Shared Gateway Mode
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="cyan" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ovn-org/ovn-kubernetes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ovn-org/ovn-kubernetes
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Introduction

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../architecture.md" class="md-tabs__link">
          
  
    
  
  Overview

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting-started/overview.md" class="md-tabs__link">
          
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../governance/CONTRIBUTING.md" class="md-tabs__link">
          
  
    
  
  Developer Guide

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../features/cluster-egress-controls/egress-ip.md" class="md-tabs__link">
          
  
    
  
  Features

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../troubleshooting/debugging.md" class="md-tabs__link">
          
  
    
  
  Troubleshooting

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../observability/metrics.md" class="md-tabs__link">
          
  
    
  
  Observability

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../blog/" class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OVN Kubernetes" class="md-nav__button md-logo" aria-label="OVN Kubernetes" data-md-component="logo">
      
  <img src="../../images/ovn-inside-k8s.png" alt="logo">

    </a>
    OVN Kubernetes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ovn-org/ovn-kubernetes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ovn-org/ovn-kubernetes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Overview
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topology.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network Topology
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gateway-modes.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gateway Modes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../traffic-flows.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Traffic Flows
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pod-creation-workflow.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pod Creation Workflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../service-creation-workflow.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Service Creation Workflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../service-traffic-policy.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Service Traffic Policy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../host-to-node-port-hairpin-trafficflow.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Host To NodePort Hairpin
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../external-ip-and-loadbalancer-ingress.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ExternalIPs/LoadBalancerIngress
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ovn-kubernetes-subnets.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Internal Subnets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../live-migration.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubevirt VM Live Migration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/overview.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OVN Kubernetes Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/launching-ovn-kubernetes.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Launching OVN Kubernetes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/example-pod-creation.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying Workloads on OVN Kubernetes cluster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/example-service creation.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying Services on OVN Kubernetes cluster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/building-ovn-kubernetes.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup and Building
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/running-release.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run OVN Kubernetes From Release Image
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/running-rpm.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run OVN Kubernetes From RPM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/cli-guide.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLI Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/configuration.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration Guide
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Developer Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Developer Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../governance/CONTRIBUTING.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../governance/REVIEWING.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reviewing Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/developer.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Coding Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/api-spec.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes CRD API-Reference Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/image-build.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OVN Kubernetes Container Images
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/documentation.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documentation Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/testing.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Local Testing Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ci/ci.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CI Testing Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/debugging.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debugging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/release.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Releasing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Features
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ClusterEgressControls
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            ClusterEgressControls
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/cluster-egress-controls/egress-ip.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EgressIP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/cluster-egress-controls/egress-service.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EgressService
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/cluster-egress-controls/egress-qos.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EgressQoS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/cluster-egress-controls/egress-gateway.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EgressGateway
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    NetworkSecurityControls
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            NetworkSecurityControls
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/network-security-controls/network-policy.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NetworkPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/network-security-controls/admin-network-policy.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AdminNetworkPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/network-security-controls/egress-firewall.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EgressFirewall
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    InfrastructureSecurityControls
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            InfrastructureSecurityControls
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/infrastructure-security-controls/node-identity.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NodeIdentity
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    MultiNetworking
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            MultiNetworking
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/multi-homing.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multihoming
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/multicast.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multicast
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/live-migration.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LiveMigration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/hybrid-overlay.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HybridOverlay
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Hardware Offload
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Hardware Offload
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/hardware-offload/ovs_offload.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OVS Offload
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/hardware-offload/dpu-acceleration.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Support DPU Acceleration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Troubleshooting
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Troubleshooting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/debugging.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/ovnkube-trace.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OVNKube Trace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/logging.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Observability
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Observability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/metrics.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metrics
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../blog/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Archive
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#current-ovn-logical-topology" class="md-nav__link">
    <span class="md-ellipsis">
      Current OVN Logical Topology
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Current OVN Logical Topology">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#traffic-between-overlay-network-pod-and-nodes-ip" class="md-nav__link">
    <span class="md-ellipsis">
      Traffic Between Overlay-Network Pod and Node’s IP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traffic-between-overlay-network-pod-and-cluster-ip" class="md-nav__link">
    <span class="md-ellipsis">
      Traffic Between Overlay-Network Pod and Cluster IP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traffic-between-host-network-pod-and-cluster-ip" class="md-nav__link">
    <span class="md-ellipsis">
      Traffic Between Host-Network Pod and Cluster IP
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#new-ovn-logical-topology" class="md-nav__link">
    <span class="md-ellipsis">
      New OVN Logical Topology
    </span>
  </a>
  
    <nav class="md-nav" aria-label="New OVN Logical Topology">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ovn-features-used" class="md-nav__link">
    <span class="md-ellipsis">
      OVN Features Used
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OVN Features Used">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ovns-support-for-policy-based-routing-pbr" class="md-nav__link">
    <span class="md-ellipsis">
      OVN’s Support for Policy Based Routing (PBR)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ovns-support-for-1-to-1-nat" class="md-nav__link">
    <span class="md-ellipsis">
      OVN’s Support for 1-to-1 NAT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#packet-processing-with-distributed-gateway-port" class="md-nav__link">
    <span class="md-ellipsis">
      Packet processing with distributed gateway port
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ovn-logical-topology-with-distributed-gateway-port" class="md-nav__link">
    <span class="md-ellipsis">
      OVN Logical topology with distributed gateway port
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traffic-between-overlay-network-pod-and-nodes-ip_1" class="md-nav__link">
    <span class="md-ellipsis">
      Traffic Between Overlay-Network Pod and Node’s IP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traffic-between-overlay-network-pod-and-cluster-ip_1" class="md-nav__link">
    <span class="md-ellipsis">
      Traffic Between Overlay-Network Pod and Cluster IP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traffic-between-host-network-pod-and-cluster-ip_1" class="md-nav__link">
    <span class="md-ellipsis">
      Traffic Between Host-Network Pod and Cluster IP
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="enable-node-local-services-access-in-shared-gateway-mode">Enable Node-Local Services Access in Shared Gateway Mode<a class="headerlink" href="#enable-node-local-services-access-in-shared-gateway-mode" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>This document captures a proposal for adding a section to the current OVN Logical Topology to
support pods (both on overlay network and host network) to communicate with the services on
the node it is on. Before we jump on to the new topology, we are going to look at the current
topology and understand how it provides that access (or not) today. Next, we understand 
some of the OVN features on top of which the changes to the current topology is built on.
Finally, we are going to look at the new OVN Logical topology.</p>
<p><strong>NOTE:</strong> This change is required only for the shared gateway mode. In this mode, we share the
IP address of the node to SNAT the traffic going out of the OVN Logical network to the
physical network. The OVN Gateway router does this SNATing. When a packet with destination
IP set to the Node IP arrives on the <code>ingress</code> pipeline of the Gateway Router, it expects
the packet to be one of these things:</p>
<ol>
<li>a packet for NodePort service and it DNATs it to one of the backend IPs</li>
<li>a reply packet for an already established (or in the process of) connection</li>
</ol>
<p>If it sees a packet from the OVN logical topology towards the Node IP, then it gets dropped
since it doesn’t fit (1) or (2) above. </p>
<h2 id="current-ovn-logical-topology">Current OVN Logical Topology<a class="headerlink" href="#current-ovn-logical-topology" title="Permanent link">&para;</a></h2>
<p>The following diagram captures the OVN logical topology for a two-node k8s cluster.</p>
<p><img alt="picture alt" src="../current_ovn_topology.svg" title="Current OVN Logical Topology" /></p>
<p>All the pods in a given node are connected to a node specific logical switch named after
node’s hostname. The east-west traffic between pods on a node with all pods on all nodes,
without NAT, is provided by the distributed logical router named ovn_cluster_router. The
north-south traffic between the pod and the external network is provided by the gateway
logical router connected to the external logical switch. The outbound traffic is SNATed
on the gateway logical router and then sent out to the underlay physical network.  The
node-specific external gateway logical router is connected to the distributed logical
router by a node-specific join logical switch.</p>
<p>Since the focus of this document is the pod to node-local service traffic, let us deep dive
into it. From that point of view, there are three flows that we care about and the following
diagram captures those three traffic flows.</p>
<p><img alt="picture alt" src="../current_ovn_topology_traffic.svg" title="Current OVN Logical Topology Traffic Flows" /></p>
<p>The Logical Static Routes on the ovn_cluster_router is as shown below and will help us in
understanding the next set of sections.
<div class="highlight"><pre><span></span><code># ovn-nbctl lr-route-list ovn_cluster_router
IPv4 Routes
               10.8.51.51                192.168.1.2 dst-ip
               10.8.51.53                192.168.2.2 dst-ip
           192.168.1.0/24                100.64.0.4 src-ip
           192.168.2.0/24                100.64.0.3 src-ip
</code></pre></div></p>
<h3 id="traffic-between-overlay-network-pod-and-nodes-ip">Traffic Between Overlay-Network Pod and Node’s IP<a class="headerlink" href="#traffic-between-overlay-network-pod-and-nodes-ip" title="Permanent link">&para;</a></h3>
<p>This refers to the traffic flow (1) in the diagram above. Consider a Pod running on the overlay
network and that is scraping the metrics off of the kubelet running on the node. The following
table captures the packet trace for the “TCP SYN” packet originating at the pod. </p>
<table>
<thead>
<tr>
<th>Where</th>
<th>SrcIP:Port</th>
<th>dstIP:Port</th>
<th>comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>node2</td>
<td>192.168.2.4:9991</td>
<td>10.8.51.53:10250</td>
<td></td>
</tr>
<tr>
<td>ovn_cluster_router</td>
<td>192.168.2.4:9991</td>
<td>10.8.51.53:10250</td>
<td>A static route here sets the nexthop to 192.168.2.2 and forwards the packet to the management port</td>
</tr>
<tr>
<td>ovn-k8s-mp0</td>
<td>192.168.2.4:9991</td>
<td>10.8.51.53:10250</td>
<td>Packet is received by the dest</td>
</tr>
</tbody>
</table>
<p>The reverse path is symmetrical and re-traces all the physical/logical network elements in the
original path. All the connection-tracking states will be popped/matched and appropriate actions
will be applied and the reply packet will reach the pod.</p>
<h3 id="traffic-between-overlay-network-pod-and-cluster-ip">Traffic Between Overlay-Network Pod and Cluster IP<a class="headerlink" href="#traffic-between-overlay-network-pod-and-cluster-ip" title="Permanent link">&para;</a></h3>
<p>This refers to the traffic flow (2) in the diagram above. Consider a pod running on the K8s API
server and wants to connect to the kubernetes service cluster IP (say, 10.96.0.1). The backend
IP for this is the local node itself. The following table captures the packet trace for the
“TCP SYN” packet originating at the pod.</p>
<table>
<thead>
<tr>
<th>Where</th>
<th>SrcIP:Port</th>
<th>dstIP:Port</th>
<th>comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>node1</td>
<td>192.168.1.4:9991</td>
<td>10.96.0.1:443</td>
<td>A LB DNAT rule here DNAT’s the VIP of 10.96.0.1:443 to 10.8.51.51:6443</td>
</tr>
<tr>
<td>ovn_cluster_router</td>
<td>192.168.1.4:9991</td>
<td>10.8.51.51:6443</td>
<td>A static route here sets the nexthop to 100.64.0.3 and forwards the packet to node’s local gateway router</td>
</tr>
<tr>
<td>ovn-k8s-mp0</td>
<td>192.168.1.4:9991</td>
<td>10.8.51.51:10250</td>
<td>Packet is received by the dest</td>
</tr>
</tbody>
</table>
<p>The reverse path is symmetrical and re-traces all the physical/logical network elements in
the original path. In fact, this flow is similar to the 1st flow after the DNAT occurs.</p>
<h3 id="traffic-between-host-network-pod-and-cluster-ip">Traffic Between Host-Network Pod and Cluster IP<a class="headerlink" href="#traffic-between-host-network-pod-and-cluster-ip" title="Permanent link">&para;</a></h3>
<p>This refers to the traffic flow (3) in the diagram above. Consider a host network pod, say
Multus,  running on the K8s API server and wants to connect to the kubernetes service cluster
IP (say, 10.96.0.1) to get network attachment information. The backend IP for this is the
local node itself. The following table captures the packet trace for the “TCP SYN” packet
originating on the node. Depending on the application, it is possible that the source IP
address could be the node’s IP or the management port’s IP address.</p>
<table>
<thead>
<tr>
<th>Where</th>
<th>SrcIP:Port</th>
<th>dstIP:Port</th>
<th>comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>ovn-k8s-mp0</td>
<td>10.8.51.51:9991 or 192.168.1.2:9991</td>
<td>10.96.0.1:443</td>
<td>An iptable SNAT rule on the host translates all the packets entering the management port with management port’s IP address</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.1.2:9991</td>
<td>10.96.0.1:443</td>
<td>A LB DNAT rule here DNAT’s the VIP of 10.96.0.1:443 to 10.8.51.51:6443</td>
</tr>
<tr>
<td>ovn_cluster_router</td>
<td>192.168.1.2:9991</td>
<td>10.8.51.51:6443</td>
<td>A static route here sets the nexthop to 100.64.0.3 and forwards the packet to node’s local gateway router</td>
</tr>
<tr>
<td>ovn-k8s-mp0</td>
<td>192.168.1.2:9991</td>
<td>10.8.51.51:10250</td>
<td>Packet is received by the dest</td>
</tr>
<tr>
<td>Reply packet from the host (Gets dropped)</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>loopback</td>
<td>10.8.51.51:10250</td>
<td>192.168.1.2:9991</td>
<td>Packet drop (see below)</td>
</tr>
</tbody>
</table>
<p>The reply packet from the host gets dropped on the floor on the host. Both of the IP addresses
10.8.51.51 and 192.168.1.2 are on the directly attached interface in the host network
namespace. So, the host stack tries to short-circuit the packet within the host and the TCP
state machine cannot match the sent ACK  because it comes in as (src:10.8.51.51,
 dst 192.168.1.2) whilst the SYN was sent as (src:192.168.1.2, dst:10.96.0.1).</p>
<p>We have tried connection marking using iptable rules in <code>mangle table</code> and using Linux Policy
Based Routing (via ip rule) to make such packets to lookup a different routing table, but
nothing works. It only complicates the OVN K8s control plane.</p>
<p>We are striving hard to ensure that the OVN K8s Control Plane is completely confined to the
OVN feature set. Having to rely on both OVN features and iptables/iprules on the host stack
complicates the control plane and makes it harder to debug and reason about.</p>
<h2 id="new-ovn-logical-topology">New OVN Logical Topology<a class="headerlink" href="#new-ovn-logical-topology" title="Permanent link">&para;</a></h2>
<p>As it is clear from the previous section that the static routes on the distributed router
that steers traffic to local node services through management port only works for
two-out-of-three flows mentioned in the aforementioned sections. The new topology provides a
clean path for all the three flows and this is achieved with the help of a distributed gateway
port, policy based routing policies, and 1-to-1 NAT. </p>
<h3 id="ovn-features-used">OVN Features Used<a class="headerlink" href="#ovn-features-used" title="Permanent link">&para;</a></h3>
<p>Before we dive into the new logical topology, it is important to understand the following
three concepts (please see the diagram below on how these three things tie together)</p>
<p><img alt="picture alt" src="../ovn_features.svg" title="OVN Features" /></p>
<h4 id="ovns-support-for-policy-based-routing-pbr">OVN’s Support for Policy Based Routing (PBR)<a class="headerlink" href="#ovns-support-for-policy-based-routing-pbr" title="Permanent link">&para;</a></h4>
<p>PBR provides a way to configure reroute policies on the logical router. These policies are
captured in a policy-routing table in the router's ingress pipeline. This table itself is
present after the IP routing table and therefore can override routing decisions and provide
a different next-hop. The new topology leverages this feature to steer the traffic from pods
on nodes to node-local services in certain ways.</p>
<h4 id="ovns-support-for-1-to-1-nat">OVN’s Support for 1-to-1 NAT<a class="headerlink" href="#ovns-support-for-1-to-1-nat" title="Permanent link">&para;</a></h4>
<p>One can configure one-to-one NAT for a logical port so that all the packets from the logical
port heading out of logical topology will be SNATed to this exclusive IP, called external_ip,
set aside for it. Since the external_ip is dedicated to the logical_port, the NATing can
occur on the chassis where the logical port is bound. The new topology leverages this
feature on every node.</p>
<h4 id="packet-processing-with-distributed-gateway-port">Packet processing with distributed gateway port<a class="headerlink" href="#packet-processing-with-distributed-gateway-port" title="Permanent link">&para;</a></h4>
<p>We create a distributed gateway port (DGP)  on a distributed router by adding a logical router
port to it and connecting that port to a logical switch that has a localnet port (pathway to
underlay). For the DGP, we also need to specify the chassis on which this port must be bound.
The packets flowing through the DGP are either processed centrally on the bound chassis or are
processed on the local chassis. For this reason, a DGP comes as two ports -- 
chassis-redirect-DGP (cr-DGP) and DGP. If the packet needs to be centrally processed, then it
is sent to cr-DGP which then forwards the packet to the bound gateway chassis through a
geneve tunnel. On the other hand, if the packet needs to be locally processed then it is sent
to the DGP that exists on the local chassis (and every chassis since its distributed).</p>
<p>Flows requiring central processing:
- If the packets from the logical switches behind the distributed router want to exit out of
the logical topology and if there is no one-to-one NAT mapping for the said traffic flow,
then the packets are redirected to cr-DGP.
- ARP resolution of the nexthop physical gateway occurs on the bound chassis through the local
net port</p>
<p>Flows that can be locally processed:
- If there is a matching one-to-one NAT rule for an outbound network traffic, then it is sent
to DGP that is locally present on the chassis.</p>
<h3 id="ovn-logical-topology-with-distributed-gateway-port">OVN Logical topology with distributed gateway port<a class="headerlink" href="#ovn-logical-topology-with-distributed-gateway-port" title="Permanent link">&para;</a></h3>
<p>The following diagram captures the new logical topology with the distributed gateway port created
on the distributed router, ovn_cluster_router</p>
<p><img alt="picture alt" src="../ovn_new_topology.svg" title="OVN New Topology" /></p>
<p>There is no change to the
path taken by the east-west traffic between the pods on all the nodes and 
path taken by the north-south traffic from the pods on a node to external network 
from the current topology.</p>
<p>However, the traffic between the pods on a node to node-local services changes and they now go through the distributed gateway port on the node itself. Note that there is no centralized processing whatsoever in this topology. So, we don’t need to handle HA for DGP and there is no need to run BFD between all the chassises and the HA gateway chassises.</p>
<p>The following diagram captures the three traffic flows in the new logical topology</p>
<p><img alt="picture alt" src="../ovn_new_topology_traffic.svg" title="OVN New Topology" /></p>
<p>The following Logical Static Routes, Logical Policies, and NAT rules on the distributed router helps us understand the next set of sections.
<div class="highlight"><pre><span></span><code>$ ovn-nbctl lr-route-list ovn_cluster_router
IPv4 Routes
            192.168.1.0/24                100.64.1.1 src-ip
            192.168.2.0/24                100.64.0.1 src-ip
$ ovn-nbctl lr-policy-list ovn_cluster_router
Routing Policies
      1005 ip4.src == 192.168.1.2 &amp;&amp; ip4.dst == 10.8.51.51         reroute        169.254.0.1
      1005 ip4.src == 192.168.2.2 &amp;&amp; ip4.dst == 10.8.51.53         reroute        169.254.0.1
      1004 inport == &quot;rtos-k8s-node1&quot; &amp;&amp; ip4.dst == 10.8.51.51   reroute        192.168.1.2
      1004 inport == &quot;rtos-k8s-node2&quot; &amp;&amp; ip4.dst == 10.8.51.53   reroute        192.168.2.2
$ ovn-nbctl lr-nat-list ovn_cluster_router
TYPE                  EXTERNAL_IP   LOGICAL_IP      EXTERNAL_MAC     LOGICAL_PORT
dnat_and_snat    169.254.0.3       192.168.1.2         c6:c6:d9:06:9f:a1      k8s-k8s-node1
dnat_and_snat    169.254.0.4       192.168.2.2          6e:52:2d:6e:91:16    k8s-k8s-node2
</code></pre></div></p>
<h3 id="traffic-between-overlay-network-pod-and-nodes-ip_1">Traffic Between Overlay-Network Pod and Node’s IP<a class="headerlink" href="#traffic-between-overlay-network-pod-and-nodes-ip_1" title="Permanent link">&para;</a></h3>
<p>This refers to the traffic flow (1) in the diagram above. Consider a Pod running on the
overlay network and that is scraping the metrics off of the kubelet running on the node.
The following table captures the packet trace for the “TCP SYN” packet originating at the
pod.</p>
<table>
<thead>
<tr>
<th>Where</th>
<th>SrcIP:Port</th>
<th>dstIP:Port</th>
<th>comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>node2</td>
<td>192.168.2.4:9991</td>
<td>10.8.51.53:10250</td>
<td></td>
</tr>
<tr>
<td>ovn_cluster_router</td>
<td>192.168.2.4:9991</td>
<td>10.8.51.53:10250</td>
<td>A logical policy rule of priority 1004 will set the nexthop to the management port IP (192.168.2.2) and forwards the packet to ovn-k8s-mp0</td>
</tr>
<tr>
<td>ovn-k8s-mp0</td>
<td>192.168.2.4:9991</td>
<td>10.8.51.53:10250</td>
<td>Packet is received by the dest</td>
</tr>
</tbody>
</table>
<p>The reverse path is symmetrical and re-traces all the physical/logical network elements in
the original path.  In the new topology, there is no NATing for this traffic at all. It is
just re-routed to through different nexthop. The PBR rule used is:
<div class="highlight"><pre><span></span><code>1004 inport == &quot;rtos-k8s-node2&quot; &amp;&amp; ip4.dst == 10.8.51.53 /* k8s-node2 */  reroute  192.168.2.2
</code></pre></div></p>
<h3 id="traffic-between-overlay-network-pod-and-cluster-ip_1">Traffic Between Overlay-Network Pod and Cluster IP<a class="headerlink" href="#traffic-between-overlay-network-pod-and-cluster-ip_1" title="Permanent link">&para;</a></h3>
<p>This refers to the traffic flow (2) in the diagram above. Consider a pod running on the K8s
API server and wants to connect to the kubernetes service cluster IP (say, 10.96.0.1). The
backend IP for this is the local node itself. The following table captures the packet trace for the “TCP SYN” packet originating at the pod.</p>
<table>
<thead>
<tr>
<th>Where</th>
<th>SrcIP:Port</th>
<th>dstIP:Port</th>
<th>comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>node1</td>
<td>192.168.1.4:9991/10.96.0.1:443/A LB DNAT rule here DNAT’s the VIP of 10.96.0.1:443 to 10.8.51.51:6443</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ovn_cluster_router</td>
<td>192.168.1.4:9991</td>
<td>10.8.51.51:6443</td>
<td>A logical policy rule of priority 1004 will set the nexthop to the management port IP and forwards the packet to ovn-k8s-mp0</td>
</tr>
<tr>
<td>ovn-k8s-mp0</td>
<td>192.168.1.4:9991</td>
<td>10.8.51.51:6443</td>
<td>Packet is received by the dest</td>
</tr>
</tbody>
</table>
<p>The reverse path is symmetrical and re-traces all the physical/logical network elements in 
the original path. In fact, this flow is similar to the 1st flow after the DNAT occurs. It 
hits the same PBR rule and gets forwarded to the management port.</p>
<h3 id="traffic-between-host-network-pod-and-cluster-ip_1">Traffic Between Host-Network Pod and Cluster IP<a class="headerlink" href="#traffic-between-host-network-pod-and-cluster-ip_1" title="Permanent link">&para;</a></h3>
<p>This refers to the traffic flow (3) in the diagram above. Consider a host network pod, say
Multus,  running on the K8s API server and wants to connect to the kubernetes service cluster
 P (say, 10.96.0.1) to get network attachment information. The backend IP for this is the
 local node itself. The following table captures the packet trace for the “TCP SYN” packet
 originating on the node. Depending on the application, it is possible that the source IP
 address could be the node’s IP or the management port’s IP address.</p>
<table>
<thead>
<tr>
<th>Where</th>
<th>SrcIP:Port</th>
<th>dstIP:Port</th>
<th>comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>ovn-k8s-mp0</td>
<td>10.8.51.51:9991 or 192.168.1.2:9991</td>
<td>10.96.0.1:443</td>
<td>An iptable SNAT rule on the host translates all the packets entering the management port with its IP address</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.1.2:9991</td>
<td>10.96.0.1:443</td>
<td>A LB DNAT rule here DNAT’s the VIP of 10.96.0.1:443 to 10.8.51.51:6443</td>
</tr>
<tr>
<td>ovn_cluster_router</td>
<td>192.168.1.2:9991</td>
<td>10.8.51.51:6443</td>
<td>A logical policy rule of priority 1005 will set the nexthop to 169.254.0.1 which is outside of the logical topology and on the host. So, the packet now needs to exit out and that IP is reachable through DGP.</td>
</tr>
<tr>
<td>rtos-node_local_switch</td>
<td>192.168.1.2:9991</td>
<td>10.8.51.51:6443</td>
<td>A dnat_and_snat rule (1-to-1 NATing) gets matched and the packet is SNATed with that IP and this happens on the local node/chassis/hypervisor.</td>
</tr>
<tr>
<td>node_local_switch</td>
<td>169.254.0.4:9991</td>
<td>10.8.51.51:6443</td>
<td>Forwards the packet to br-local OVS bridge on the host</td>
</tr>
<tr>
<td>ovn-k8s-gw0</td>
<td>169.254.0.4:9991</td>
<td>10.8.51.51:6443</td>
<td>Packet is received by the dest</td>
</tr>
</tbody>
</table>
<p>The reverse path is symmetrical and re-traces all the physical/logical network elements in
the original path. All the connection-tracking states will be popped/matched and appropriate
actions will be applied and will reach the pod. The PBR rule used is:
<div class="highlight"><pre><span></span><code>1005 ip4.src == 192.168.1..2 &amp;&amp; ip4.dst == 10.8.51.51 /* k8s-node1 */   reroute     169.254.0.1
</code></pre></div></p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<p>The google doc version of the same is here:
https://docs.google.com/document/d/1DfbcAezbZD4Ipswz6UOn30S6B6f6eoiLkTCVmTa43Vk/edit?usp=sharing</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.tabs", "navigation.tabs.sticky", "content.code.annotate", "navigation.instant.preview"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.8fd75fb4.min.js"></script>
      
    
  </body>
</html>