<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/ovn-kubernetes/assets/css/style.css?v=9e6c62f21184b23c5bdbecd995abe5f149115b0f" media="screen" type="text/css">
    <link rel="stylesheet" href="/ovn-kubernetes/assets/css/print.css" media="print" type="text/css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>External IP and LoadBalancer Ingress | OVN-Kubernetes Homepage</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="External IP and LoadBalancer Ingress" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="test" />
<meta property="og:description" content="test" />
<link rel="canonical" href="http://www.ovn.org/ovn-kubernetes/external-ip-and-loadbalancer-ingress.html" />
<meta property="og:url" content="http://www.ovn.org/ovn-kubernetes/external-ip-and-loadbalancer-ingress.html" />
<meta property="og:site_name" content="OVN-Kubernetes Homepage" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="External IP and LoadBalancer Ingress" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"test","headline":"External IP and LoadBalancer Ingress","url":"http://www.ovn.org/ovn-kubernetes/external-ip-and-loadbalancer-ingress.html"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/ovn-kubernetes/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="http://www.ovn.org/ovn-kubernetes/">
          <h1>OVN-Kubernetes Homepage</h1>
        </a>
        <h2>test</h2>
        
          <a href="https://github.com/ovn-org/ovn-kubernetes" class="button"><small>View project on</small> GitHub</a>
        
        
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1 id="external-ip-and-loadbalancer-ingress">External IP and LoadBalancer Ingress</h1>

<p>OVN Kubernetes implements both External IPs and LoadBalancer Ingress IPs (<code class="language-plaintext highlighter-rouge">service.Status.LoadBalancer.Ingress</code>) in the form of OVN load balancers. These OVN load balancers live on all of the Kubernetes nodes and are thus highly available and ready for load sharing. It is the administrator’s responsibility to route traffic to the Kubernetes nodes for both of these VIP types.</p>

<p>In an environment where External IPs and LoadBalancer Ingress VIPs happen to be part of the nodes’ subnets, administrators might expect that OVN Kubernetes answer to ARP requests to these VIPs. However, this is not the case. The administrator is responsible for routing packets to the Kubernetes nodes and they cannot rely on the network plugin for this to happen.</p>

<h4 id="external-ip">External IP</h4>

<p>The Kubernetes documentation states that External IPs are to be handled by the cluster administrator and are not the responsibility of the network plugin. See the following quote from the kubernetes documentation:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>External IPs

If there are external IPs that route to one or more cluster nodes, Kubernetes Services can be exposed on those externalIPs. Traffic that ingresses into the cluster with the external IP (as destination IP), on the Service port, will be routed to one of the Service endpoints. externalIPs are not managed by Kubernetes and are the responsibility of the cluster administrator.
</code></pre></div></div>
<blockquote>
  <p>Source: <a href="https://kubernetes.io/docs/concepts/services-networking/service/#external-ips">https://kubernetes.io/docs/concepts/services-networking/service/#external-ips</a></p>
</blockquote>

<h4 id="loadbalancer-ingress-servicestatusloadbalanceringress">LoadBalancer Ingress (service.Status.LoadBalancer.Ingress)</h4>

<p>For a service’s Status LoadBalancer Ingress field <code class="language-plaintext highlighter-rouge">service.Status.LoadBalancer.Ingress</code>, the aforementioned statement applies in exactly the same manner. Both External IP and <code class="language-plaintext highlighter-rouge">service.Status.LoadBalancer.Ingress</code> should behave the same from the network plugin’s behavior, and it is the administrator’s responsibility to get traffic for the VIPs into the cluster.</p>

<h4 id="implementation-details">Implementation details</h4>

<p>OVN Kubernetes exposes External IPs and <code class="language-plaintext highlighter-rouge">service.Status.LoadBalancer.Ingress</code> VIPs as OVN load balancers on every node in the cluster. However, OVN Kubernetes will not answer to ARP requests to these VIP types, even if they reside on a node local subnet. This is because otherwise, every node in the cluster would answer with its own ARP reply to the same ARP request, leading to potential issues with stateful network flows that are tracked by conntrack. See the discussion in <a href="https://github.com/ovn-org/ovn-kubernetes/issues/2407">https://github.com/ovn-org/ovn-kubernetes/issues/2407</a> for further details.</p>

<p>In fact, OVN Kubernetes implements explicit bypass rules for ARP requests to these VIP types on the external bridge (<code class="language-plaintext highlighter-rouge">br-ex</code> or <code class="language-plaintext highlighter-rouge">breth0</code> in most deployments). Any ARP request to such an IP that comes in from the physical port will bypass the OVN dataplane and it will be sent to host’s networking stack on purpose. If an ARP reponse to a VIP is expeced, make sure the VIP is added to the host’s networking stack.</p>

<p>For implementation details, see:</p>
<ul>
  <li><a href="https://github.com/ovn-org/ovn-kubernetes/blob/00925a6c64f57f03b2918eb48ff589c3417ddaa9/go-controller/pkg/node/gateway_shared_intf.go#L336">https://github.com/ovn-org/ovn-kubernetes/blob/00925a6c64f57f03b2918eb48ff589c3417ddaa9/go-controller/pkg/node/gateway_shared_intf.go#L336</a></li>
  <li><a href="https://github.com/ovn-org/ovn-kubernetes/blob/00925a6c64f57f03b2918eb48ff589c3417ddaa9/go-controller/pkg/node/gateway_shared_intf.go#L344">https://github.com/ovn-org/ovn-kubernetes/blob/00925a6c64f57f03b2918eb48ff589c3417ddaa9/go-controller/pkg/node/gateway_shared_intf.go#L344</a></li>
  <li><a href="https://github.com/ovn-org/ovn-kubernetes/pull/2540">https://github.com/ovn-org/ovn-kubernetes/pull/2540</a></li>
  <li><a href="https://github.com/ovn-org/ovn-kubernetes/pull/2394">https://github.com/ovn-org/ovn-kubernetes/pull/2394</a></li>
</ul>

<h4 id="guidance-for-administrators">Guidance for administrators</h4>

<p>This absence of ARP replies from OVN Kubernetes means that administrators must take extra actions to make External IPs and LoadBalancer Ingress VIPs work, even when these VIPs reside on one of the node local subnets.</p>

<p>For External IPs, administrators can either assign the External IP to one of the nodes’ Linux networking stacks if the External IP falls into one of the node’s subnets. In this case, ARP requests to the External IP will be answered with ARP replies by the node that was assigned the External IP. For example, an admin could run <code class="language-plaintext highlighter-rouge">ip address add &lt;externalIP&gt;/32 dev lo</code> to make this work, assuming that <code class="language-plaintext highlighter-rouge">arp_ignore</code> is at its default setting of <code class="language-plaintext highlighter-rouge">0</code> and thus the Linux networking stack uses the default <a href="https://en.wikipedia.org/wiki/Host_model">weak host model</a> for ARP replies. An alternative could be to point one or multiple static routes for the External IP to one or several of the Kubernetes nodes.</p>

<p>For LoadBalancer Ingress VIPs, an administrator will either use a tool such as MetalLB L2 mode. Or, they can configure ECMP load-sharing. ECMP load-sharing can be implemented via static routes which point to all Kubernetes nodes or via BGP route injection (e.g., MetalLB’s BGP mode).</p>

        </section>

        <aside id="sidebar">
          

          
            <p class="repo-owner"><a href="https://github.com/ovn-org/ovn-kubernetes">ovn-kubernetes</a> is maintained by <a href="https://github.com/ovn-org">ovn-org</a>.</p>
          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

  </body>
</html>
