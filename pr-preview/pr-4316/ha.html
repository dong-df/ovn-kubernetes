<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/ovn-kubernetes/assets/css/style.css?v=9e6c62f21184b23c5bdbecd995abe5f149115b0f" media="screen" type="text/css">
    <link rel="stylesheet" href="/ovn-kubernetes/assets/css/print.css" media="print" type="text/css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>OVN central database High-availability | OVN-Kubernetes Homepage</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="OVN central database High-availability" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="test" />
<meta property="og:description" content="test" />
<link rel="canonical" href="http://www.ovn.org/ovn-kubernetes/ha.html" />
<meta property="og:url" content="http://www.ovn.org/ovn-kubernetes/ha.html" />
<meta property="og:site_name" content="OVN-Kubernetes Homepage" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="OVN central database High-availability" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"test","headline":"OVN central database High-availability","url":"http://www.ovn.org/ovn-kubernetes/ha.html"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/ovn-kubernetes/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="http://www.ovn.org/ovn-kubernetes/">
          <h1>OVN-Kubernetes Homepage</h1>
        </a>
        <h2>test</h2>
        
          <a href="https://github.com/ovn-org/ovn-kubernetes" class="button"><small>View project on</small> GitHub</a>
        
        
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1 id="ovn-central-database-high-availability">OVN central database High-availability</h1>

<p>OVN architecture has two central databases that can be clustered.
The databases are OVN_Northbound and OVN_Southbound.  This document
explains how to cluster them and start various daemons for the
ovn-kubernetes integration.  You will ideally need at least 3 masters
for a HA cluster. (You will need a miniumum of OVS/OVN 2.9.2
for clustering.)</p>

<h2 id="master1-initialization">Master1 initialization</h2>

<p>To bootstrap your cluster, you need to start on one master.
For a lack of better name, let’s call it MASTER1 with an IP
address of $MASTER1</p>

<p>On MASTER1, delete any stale OVN databases and stop any
ovn-northd running. e.g:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo /usr/share/openvswitch/scripts/ovn-ctl stop_nb_ovsdb
sudo /usr/share/openvswitch/scripts/ovn-ctl stop_sb_ovsdb
sudo rm /etc/openvswitch/ovn*.db
sudo /usr/share/openvswitch/scripts/ovn-ctl stop_northd
</code></pre></div></div>

<p>Start the two databases on that host with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LOCAL_IP=$MASTER1
sudo /usr/share/openvswitch/scripts/ovn-ctl \
    --db-nb-cluster-local-addr=$LOCAL_IP start_nb_ovsdb

sudo /usr/share/openvswitch/scripts/ovn-ctl \
    --db-sb-cluster-local-addr=$LOCAL_IP start_sb_ovsdb
</code></pre></div></div>

<h2 id="master2-master3-initialization">Master2, Master3… initialization</h2>

<p>Delete any stale databases and stop any running ovn-northd
daemons. e.g:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo /usr/share/openvswitch/scripts/ovn-ctl stop_nb_ovsdb
sudo /usr/share/openvswitch/scripts/ovn-ctl stop_sb_ovsdb
sudo rm /etc/openvswitch/ovn*.db
sudo /usr/share/openvswitch/scripts/ovn-ctl stop_northd
</code></pre></div></div>

<p>On master with a IP of $LOCAL_IP, start the databases and ask it to
join $MASTER1</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LOCAL_IP=$LOCAL_IP
MASTER_IP=$MASTER1

sudo /usr/share/openvswitch/scripts/ovn-ctl  \
    --db-nb-cluster-local-addr=$LOCAL_IP \
    --db-nb-cluster-remote-addr=$MASTER_IP start_nb_ovsdb

sudo /usr/share/openvswitch/scripts/ovn-ctl  \
    --db-sb-cluster-local-addr=$LOCAL_IP \
    --db-sb-cluster-remote-addr=$MASTER_IP start_sb_ovsdb
</code></pre></div></div>

<p>This should get your cluster up and running. You can verify the
status of your cluster with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ovs-appctl -t /var/run/openvswitch/ovnnb_db.ctl \
    cluster/status OVN_Northbound

sudo ovs-appctl -t /var/run/openvswitch/ovnsb_db.ctl \
    cluster/status OVN_Southbound
</code></pre></div></div>

<h2 id="ovnkube-master-ha-setup">ovnkube master HA setup</h2>

<p>ovnkube master has 2 main components - cluster-manager and ovnkube-controller.</p>

<p>Starting ovnkube with ‘-init-master’, runs both the components.  It is also possible
to run these components individually by starting 2 ovnkube’s one with ‘-init-cluster-manager’
and the other with ‘-init-ovnkube-controller’.</p>

<p>On the master nodes, we can either</p>
<ul>
  <li>start ovnkube with ‘-init-master’
This should be a deployment running on master nodes. Eg.</li>
</ul>

<p>IP1=”$MASTER1”
IP2=”$MASTER2”
IP3=”$MASTER3”</p>

<p>ovn_nb=”tcp:$IP1:6641,tcp:$IP2:6641,tcp:$IP3:6641”
ovn_sb=”tcp:$IP1:6642,tcp:$IP2:6642,tcp:$IP3:6642”</p>

<p>nohup sudo ovnkube -k8s-kubeconfig kubeconfig.yaml <br />
 -loglevel=4 <br />
 -k8s-apiserver=”http://$K8S_APISERVER_IP:8080” <br />
 -logfile=”/var/log/openvswitch/ovnkube.log” <br />
 -init-master=”$NODENAME” -cluster-subnets=”$CLUSTER_IP_SUBNET” <br />
 -init-node=”$NODENAME” <br />
 -k8s-service-cidr=”$SERVICE_IP_SUBNET” <br />
 -k8s-token=”$TOKEN” <br />
 -nodeport <br />
 -nb-address=”${ovn_nb}” <br />
 -sb-address=”${ovn_sb}”  2&gt;&amp;1 &amp;</p>

<ul>
  <li>start ‘ovnkube -init-cluster-manager’ and ‘ovnkube -init-ovnkube-controller’
This should be a deployment with these 2 as containers</li>
</ul>

<p>Eg.</p>

<p>ovnkube master supports running in 3 modes.
init-master mode, init-cluster-manager mode or init-ovnkube-controller
mode.  If ovnkube is run with “-init-master” mode, then there is
no need to run the other modes because master mode enables both cluster-manager
and ovnkube-controller.  If the user desires to run cluster-manager
and ovnkube-controller separately, then it is possible to do
so by running</p>

<p>nohup sudo ovnkube -k8s-kubeconfig kubeconfig.yaml <br />
 -loglevel=4 <br />
 -k8s-apiserver=”http://$K8S_APISERVER_IP:8080” <br />
 -logfile=”/var/log/openvswitch/ovnkube.log” <br />
 -init-ovnkube-controller=”$NODENAME” -cluster-subnets=”$CLUSTER_IP_SUBNET” <br />
 -init-node=”$NODENAME” <br />
 -k8s-service-cidr=”$SERVICE_IP_SUBNET” <br />
 -k8s-token=”$TOKEN” <br />
 -nodeport <br />
 -nb-address=”${ovn_nb}” <br />
 -sb-address=”${ovn_sb}”  2&gt;&amp;1 &amp;</p>

<p>nohup sudo ovnkube -k8s-kubeconfig kubeconfig.yaml <br />
 -loglevel=4 <br />
 -k8s-apiserver=”http://$K8S_APISERVER_IP:8080” <br />
 -logfile=”/var/log/openvswitch/ovnkube.log” <br />
 -init-cluster-manager=”$NODENAME” -cluster-subnets=”$CLUSTER_IP_SUBNET” <br />
 -init-node=”$NODENAME” <br />
 -k8s-service-cidr=”$SERVICE_IP_SUBNET” <br />
 -k8s-token=”$TOKEN” <br />
 -nodeport  2&gt;&amp;1 &amp;</p>

<h2 id="start-ovn-northd">start ovn-northd</h2>

<p>On any one of the masters (ideally via a daemonset with replica count as 1),
start ovn-northd. Let the 3 master IPs be $IP1, $IP2 and $IP3.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IP1="$MASTER1"
IP2="$MASTER2"
IP3="$MASTER3"

export ovn_nb="tcp:$IP1:6641,tcp:$IP2:6641,tcp:$IP3:6641"
export ovn_sb="tcp:$IP1:6642,tcp:$IP2:6642,tcp:$IP3:6642"

sudo ovn-northd -vconsole:emer -vsyslog:err -vfile:info \
    --ovnnb-db="$ovn_nb" --ovnsb-db="$ovn_sb" --no-chdir \
    --log-file=/var/log/openvswitch/ovn-northd.log \
    --pidfile=/var/run/openvswitch/ovn-northd.pid --detach --monitor
</code></pre></div></div>

<h2 id="start-ovn-kube--init-node">Start ‘ovn-kube -init-node’</h2>

<p>On all nodes (and if needed on other masters), start ovnkube with
‘-init-node’. For e.g:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IP1="$MASTER1"
IP2="$MASTER2"
IP3="$MASTER3"

ovn_nb="tcp:$IP1:6641,tcp:$IP2:6641,tcp:$IP3:6641"
ovn_sb="tcp:$IP1:6642,tcp:$IP2:6642,tcp:$IP3:6642"

nohup sudo ovnkube -k8s-kubeconfig $HOME/kubeconfig.yaml -loglevel=4 \
    -logfile="/var/log/openvswitch/ovnkube.log" \
    -k8s-apiserver="http://$K8S_APISERVER_IP:8080" \
    -init-node="$NODE_NAME"  \
    -nb-address="${ovn_nb}" \
    -sb-address="${ovn_sb}" \
    -k8s-token="$TOKEN" \
    -init-gateways \
    -k8s-service-cidr= \
    -cluster-subnets="$SERVICE_IP_SUBNET" 2&gt;&amp;1 &amp;
</code></pre></div></div>

        </section>

        <aside id="sidebar">
          

          
            <p class="repo-owner"><a href="https://github.com/ovn-org/ovn-kubernetes">ovn-kubernetes</a> is maintained by <a href="https://github.com/ovn-org">ovn-org</a>.</p>
          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

  </body>
</html>
