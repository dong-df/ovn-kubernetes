<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/ovn-kubernetes/assets/css/style.css?v=9e6c62f21184b23c5bdbecd995abe5f149115b0f" media="screen" type="text/css">
    <link rel="stylesheet" href="/ovn-kubernetes/assets/css/print.css" media="print" type="text/css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>EgressQoS | OVN-Kubernetes Homepage</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="EgressQoS" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="test" />
<meta property="og:description" content="test" />
<link rel="canonical" href="http://www.ovn.org/ovn-kubernetes/egress-qos.html" />
<meta property="og:url" content="http://www.ovn.org/ovn-kubernetes/egress-qos.html" />
<meta property="og:site_name" content="OVN-Kubernetes Homepage" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="EgressQoS" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"test","headline":"EgressQoS","url":"http://www.ovn.org/ovn-kubernetes/egress-qos.html"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/ovn-kubernetes/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="http://www.ovn.org/ovn-kubernetes/">
          <h1>OVN-Kubernetes Homepage</h1>
        </a>
        <h2>test</h2>
        
          <a href="https://github.com/ovn-org/ovn-kubernetes" class="button"><small>View project on</small> GitHub</a>
        
        
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1 id="egressqos">EgressQoS</h1>

<h2 id="introduction">Introduction</h2>

<p>The EgressQoS feature enables marking pods egress traffic with a valid QoS Differentiated Services Code Point (DSCP) value.
The QoS markings will be consumed and acted upon by network appliances outside of the Kubernetes cluster
to optimize traffic flow throughout their networks.</p>

<p>The EgressQoS resource is namespaced-scoped and allows specifying a set of QoS rules - each has a DSCP value, an optional
destination CIDR (dstCIDR) and an optional PodSelector (podSelector).
A rule applies its DSCP marking to traffic coming from pods whose labels match the podSelector heading to the dstCIDR.
A namespace supports having only one EgressQoS resource named <code class="language-plaintext highlighter-rouge">default</code> (other EgressQoSes will be ignored).</p>

<h2 id="example">Example</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">EgressQoS</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">k8s.ovn.org/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">egress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">dscp</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">dstCIDR</span><span class="pi">:</span> <span class="s">1.2.3.0/24</span>
  <span class="pi">-</span> <span class="na">dscp</span><span class="pi">:</span> <span class="m">42</span>
    <span class="na">podSelector</span><span class="pi">:</span>
      <span class="na">matchLabels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">example</span>
  <span class="pi">-</span> <span class="na">dscp</span><span class="pi">:</span> <span class="m">28</span>
</code></pre></div></div>

<p>This example marks the packets originating from pods in the <code class="language-plaintext highlighter-rouge">default</code> namespace in the following way:</p>
<ul>
  <li>All traffic heading to an address that belongs to 1.2.3.0/24 is marked with DSCP 30.</li>
  <li>Egress traffic from pods labeled <code class="language-plaintext highlighter-rouge">app: example</code> is marked with DSCP 42.</li>
  <li>All egress traffic is marked with DSCP 28.</li>
</ul>

<p>The priority of a rule is determined by its placement in the egress array.
An earlier rule is processed before a later rule. In this example, if the rules are reversed
all traffic originating from pods in the <code class="language-plaintext highlighter-rouge">default</code> namespace is marked with DSCP 28 - regardless of
its destination or pods labels.
Because of that specific rules should always come before general ones in that array.</p>

<h2 id="changes-in-ovn-northbound-database">Changes in OVN northbound database</h2>

<p>EgressQoS is implemented by reacting to events from <code class="language-plaintext highlighter-rouge">EgressQoSes</code>, <code class="language-plaintext highlighter-rouge">Pods</code> and <code class="language-plaintext highlighter-rouge">Nodes</code> changes -
updating OVN’s northbound database <code class="language-plaintext highlighter-rouge">QoS</code>, <code class="language-plaintext highlighter-rouge">Address_Set</code> and <code class="language-plaintext highlighter-rouge">Logical_Switch</code> objects.
The code is implemented under <code class="language-plaintext highlighter-rouge">pkg/ovn/egressqos.go</code> and most of the logic for the events sits under
the <code class="language-plaintext highlighter-rouge">syncEgressQoS</code>, <code class="language-plaintext highlighter-rouge">syncEgressQoSPod</code>, <code class="language-plaintext highlighter-rouge">syncEgressQoSNode</code> functions.</p>

<p>We’ll use the example YAML above and see how the related objects are changed in OVN’s northbound database
in a Dual-Stack kind cluster.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get nodes
NAME                STATUS   ROLES               
ovn-control-plane   Ready    control-plane,master
ovn-worker          Ready    &lt;none&gt;              
ovn-worker2         Ready    &lt;none&gt;              
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get pods -o=custom-columns=Name:.metadata.name,IPs:.status.podIPs,LABELS:.metadata.labels
Name           IPs                                             LABELS
no-labels      [map[ip:10.244.1.3] map[ip:fd00:10:244:2::3]]   &lt;none&gt;
with-labels1   [map[ip:10.244.2.3] map[ip:fd00:10:244:3::3]]   map[app:example]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get egressqoses
No resources found in default namespace.
</code></pre></div></div>

<p>At this point there are no QoS objects in the northbound database.
We create the example EgressQoS:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get egressqoses
NAME      AGE
default   6s
</code></pre></div></div>

<p>And the following is created in the northbound database (<code class="language-plaintext highlighter-rouge">SyncEgressQoS</code>):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># QoS

_uuid               : 14b923a1-d7b0-42b8-a3d7-6a5028b09ae2
action              : {dscp=30}
bandwidth           : {}
direction           : to-lport
external_ids        : {EgressQoS=default}
match               : "(ip4.dst == 1.2.3.0/24) &amp;&amp; (ip4.src == $a5154718082306775057 || ip6.src == $a5154715883283518635)"
priority            : 1000

_uuid               : 820a011d-0eda-43b7-994d-46a55620c4bf
action              : {dscp=42}
bandwidth           : {}
direction           : to-lport
external_ids        : {EgressQoS=default}
match               : "(ip4.dst == 0.0.0.0/0 || ip6.dst == ::/0) &amp;&amp; (ip4.src == $a10759091379580272948 || ip6.src == $a10759093578603529370)"
priority            : 999

_uuid               : 1e35ea19-3353-4cbc-a1f5-7ea5bf831d67
action              : {dscp=28}
bandwidth           : {}
direction           : to-lport
external_ids        : {EgressQoS=default}
match               : "(ip4.dst == 0.0.0.0/0 || ip6.dst == ::/0) &amp;&amp; (ip4.src == $a5154718082306775057 || ip6.src == $a5154715883283518635)"
priority            : 998
</code></pre></div></div>

<p>A QoS object is created for each rule specified in the EgressQoS, all attached to all of the nodes logical switches:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Logical_Switch

name                : ovn-worker
qos_rules           : [14b923a1-d7b0-42b8-a3d7-6a5028b09ae2, 1e35ea19-3353-4cbc-a1f5-7ea5bf831d67, 820a011d-0eda-43b7-994d-46a55620c4bf]

name                : ovn-worker2
qos_rules           : [14b923a1-d7b0-42b8-a3d7-6a5028b09ae2, 1e35ea19-3353-4cbc-a1f5-7ea5bf831d67, 820a011d-0eda-43b7-994d-46a55620c4bf]

name                : ovn-control-plane
qos_rules           : [14b923a1-d7b0-42b8-a3d7-6a5028b09ae2, 1e35ea19-3353-4cbc-a1f5-7ea5bf831d67, 820a011d-0eda-43b7-994d-46a55620c4bf]
</code></pre></div></div>

<p>When a new node is added to the cluster we attach all of the <code class="language-plaintext highlighter-rouge">QoS</code> objects that belong to EgressQoSes
to its logical switch as well (<code class="language-plaintext highlighter-rouge">SyncEgressQoSNode</code>).</p>

<p>Notice that QoS objects that belong to rules <strong>without</strong> a <code class="language-plaintext highlighter-rouge">podSelector</code> reference the same address sets for
their src match - which are the namespace’s address sets:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Address_Set

_uuid               : 7cb04096-7107-4a35-ae34-be4b0e0c584e
addresses           : ["10.244.1.3", "10.244.2.3"]
external_ids        : {name=default_v4}
name                : a5154718082306775057

_uuid               : 467a93c9-9c76-40bf-8318-e91ee7f6f010
addresses           : ["fd00:10:244:2::3", "fd00:10:244:3::3"]
external_ids        : {name=default_v6}
name                : a5154715883283518635
</code></pre></div></div>
<p>We only use these address sets without editing them.</p>

<p>For each rule that does have a <code class="language-plaintext highlighter-rouge">podSelector</code> an address set is created, adding the pods that match to it.
Its name (external_ids) follows the pattern <code class="language-plaintext highlighter-rouge">egress-qos-pods-&lt;rule-namespace&gt;-&lt;rule-priority&gt;</code>,
rule-priority is <code class="language-plaintext highlighter-rouge">1000 - rule's index in the array</code> which matches the QoS object’s priority that relates to that rule.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Address_Set

_uuid               : 74b8df1e-5a2d-4fa4-a5e5-57bdea61d0c5
addresses           : ["fd00:10:244:3::3"]
external_ids        : {name=egress-qos-pods-default-999_v6}
name                : a10759093578603529370

_uuid               : a718588e-0a9b-480e-9adb-2738e524b82d
addresses           : ["10.244.2.3"]
external_ids        : {name=egress-qos-pods-default-999_v4}
name                : a10759091379580272948
</code></pre></div></div>

<p>When a new pod that matches a rule’s <code class="language-plaintext highlighter-rouge">podSelector</code> is created in the namespace we add its IPs to the
relevant address set (<code class="language-plaintext highlighter-rouge">SyncEgressQoSPod</code>):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get pods -o=custom-columns=Name:.metadata.name,IPs:.status.podIPs,LABELS:.metadata.labels
Name           IPs                                             LABELS
no-labels      [map[ip:10.244.1.3] map[ip:fd00:10:244:2::3]]   &lt;none&gt;
with-labels1   [map[ip:10.244.2.3] map[ip:fd00:10:244:3::3]]   map[app:example]
with-labels2   [map[ip:10.244.2.4] map[ip:fd00:10:244:3::4]]   map[app:example]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Address_Set

_uuid               : 74b8df1e-5a2d-4fa4-a5e5-57bdea61d0c5
addresses           : ["fd00:10:244:3::3", "fd00:10:244:3::4"]
external_ids        : {name=egress-qos-pods-default-999_v6}
name                : a10759093578603529370
--
_uuid               : a718588e-0a9b-480e-9adb-2738e524b82d
addresses           : ["10.244.2.3", "10.244.2.4"]
external_ids        : {name=egress-qos-pods-default-999_v4}
name                : a10759091379580272948
</code></pre></div></div>

<p>When a pod is deleted or its labels change and do not longer match the rule’s <code class="language-plaintext highlighter-rouge">podSelector</code>
its IPs are deleted from the relevant address set:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get pods -o=custom-columns=Name:.metadata.name,IPs:.status.podIPs,LABELS:.metadata.labels
Name           IPs                                             LABELS
no-labels      [map[ip:10.244.1.3] map[ip:fd00:10:244:2::3]]   &lt;none&gt;
with-labels2   [map[ip:10.244.2.4] map[ip:fd00:10:244:3::4]]   map[app:not-the-example]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Address_Set

_uuid               : 74b8df1e-5a2d-4fa4-a5e5-57bdea61d0c5
addresses           : []
external_ids        : {name=egress-qos-pods-default-999_v6}
name                : a10759093578603529370
--
_uuid               : a718588e-0a9b-480e-9adb-2738e524b82d
addresses           : []
external_ids        : {name=egress-qos-pods-default-999_v4}
name                : a10759091379580272948
</code></pre></div></div>

<p>When an EgressQoS is updated - we recreate the QoS and Address Set objects, detach the old QoSes from the logical switches
and attach the new ones:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">EgressQoS</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">k8s.ovn.org/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">egress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">dscp</span><span class="pi">:</span> <span class="m">48</span>
    <span class="na">podSelector</span><span class="pi">:</span>
      <span class="na">matchLabels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">updated-example</span>
  <span class="pi">-</span> <span class="na">dscp</span><span class="pi">:</span> <span class="m">28</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get pods -o=custom-columns=Name:.metadata.name,IPs:.status.podIPs,LABELS:.metadata.labels
Name                  IPs                                             LABELS
no-labels             [map[ip:10.244.1.3] map[ip:fd00:10:244:2::3]]   &lt;none&gt;
with-labels2          [map[ip:10.244.2.4] map[ip:fd00:10:244:3::4]]   map[app:not-the-example]
with-updated-labels   [map[ip:10.244.1.4] map[ip:fd00:10:244:2::4]]   map[app:updated-example]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># QoS

_uuid               : cf84322a-0b9e-4aef-97bb-4dcd13f0e73d
action              : {dscp=48}
bandwidth           : {}
direction           : to-lport
external_ids        : {EgressQoS=default}
match               : "(ip4.dst == 0.0.0.0/0 || ip6.dst == ::/0) &amp;&amp; (ip4.src == $a17475935309050627288 || ip6.src == $a17475937508073883710)"
priority            : 1000

_uuid               : 8bf07e6b-ca0a-4d76-a206-b7ccb5e948d8
action              : {dscp=28}
bandwidth           : {}
direction           : to-lport
external_ids        : {EgressQoS=default}
match               : "(ip4.dst == 0.0.0.0/0 || ip6.dst == ::/0) &amp;&amp; (ip4.src == $a5154718082306775057 || ip6.src == $a5154715883283518635)"
priority            : 999
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Logical_Switch

name                : ovn-worker
qos_rules           : [8bf07e6b-ca0a-4d76-a206-b7ccb5e948d8, cf84322a-0b9e-4aef-97bb-4dcd13f0e73d]

name                : ovn-worker2
qos_rules           : [8bf07e6b-ca0a-4d76-a206-b7ccb5e948d8, cf84322a-0b9e-4aef-97bb-4dcd13f0e73d]

name                : ovn-control-plane
qos_rules           : [8bf07e6b-ca0a-4d76-a206-b7ccb5e948d8, cf84322a-0b9e-4aef-97bb-4dcd13f0e73d]
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Address_Set

_uuid               : a27cf559-0981-487f-a0ca-5a355da89cba
addresses           : ["10.244.1.4"]
external_ids        : {name=egress-qos-pods-default-1000_v4}
name                : a17475935309050627288

_uuid               : 93cdc1fd-995c-498b-88a1-4992af93c630
addresses           : ["fd00:10:244:2::4"]
external_ids        : {name=egress-qos-pods-default-1000_v6}
name                : a17475937508073883710

_uuid               : 7cb04096-7107-4a35-ae34-be4b0e0c584e
addresses           : ["10.244.1.3", "10.244.1.4", "10.244.2.4"]
external_ids        : {name=default_v4}
name                : a5154718082306775057

_uuid               : 467a93c9-9c76-40bf-8318-e91ee7f6f010
addresses           : ["fd00:10:244:2::3", "fd00:10:244:2::4", "fd00:10:244:3::4"]
external_ids        : {name=default_v6}
name                : a5154715883283518635
</code></pre></div></div>

        </section>

        <aside id="sidebar">
          

          
            <p class="repo-owner"><a href="https://github.com/ovn-org/ovn-kubernetes">ovn-kubernetes</a> is maintained by <a href="https://github.com/ovn-org">ovn-org</a>.</p>
          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

  </body>
</html>
