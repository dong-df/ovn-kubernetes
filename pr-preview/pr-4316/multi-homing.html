<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/ovn-kubernetes/assets/css/style.css?v=9e6c62f21184b23c5bdbecd995abe5f149115b0f" media="screen" type="text/css">
    <link rel="stylesheet" href="/ovn-kubernetes/assets/css/print.css" media="print" type="text/css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Multi-homing | OVN-Kubernetes Homepage</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Multi-homing" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="test" />
<meta property="og:description" content="test" />
<link rel="canonical" href="http://www.ovn.org/ovn-kubernetes/multi-homing.html" />
<meta property="og:url" content="http://www.ovn.org/ovn-kubernetes/multi-homing.html" />
<meta property="og:site_name" content="OVN-Kubernetes Homepage" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Multi-homing" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"test","headline":"Multi-homing","url":"http://www.ovn.org/ovn-kubernetes/multi-homing.html"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/ovn-kubernetes/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="http://www.ovn.org/ovn-kubernetes/">
          <h1>OVN-Kubernetes Homepage</h1>
        </a>
        <h2>test</h2>
        
          <a href="https://github.com/ovn-org/ovn-kubernetes" class="button"><small>View project on</small> GitHub</a>
        
        
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1 id="multi-homing">Multi-homing</h1>
<p>A K8s pod with more than one network interface is said to be multi-homed. The
<a href="https://github.com/k8snetworkplumbingwg/multi-net-spec">Network Plumbing Working Group</a>
has put forward a <a href="https://github.com/k8snetworkplumbingwg/multi-net-spec">standard</a>
describing how to specify the configurations for additional network interfaces.</p>

<p>There are several delegating plugins or meta-plugins (Multus, Genie)
implementing this standard.</p>

<p>After a pod is scheduled on a particular Kubernetes node, kubelet will invoke
the delegating plugin to prepare the pod for networking. This meta-plugin will
then invoke the CNI responsible for setting up the pod’s default cluster
network, and afterwards it iterates the list of additional attachments on the
pod, invoking the corresponding delegate CNI implementing the logic to attach
the pod to that particular network.</p>

<h2 id="configuring-secondary-networks">Configuring secondary networks</h2>
<p>To allow pods to have multiple network interfaces, the user must provide the
configurations specifying how to connect to these networks; these
configurations are defined in a CRD named <code class="language-plaintext highlighter-rouge">NetworkAttachmentDefinition</code>.</p>

<p>Below you will find example attachment configurations for each of the current
topologies OVN-K allows for secondary networks.</p>

<p><strong>NOTE</strong>:</p>
<ul>
  <li>networks are <strong>not</strong> namespaced - i.e. creating multiple
<code class="language-plaintext highlighter-rouge">network-attachment-definition</code>s with different configurations pointing at the
same network (same <code class="language-plaintext highlighter-rouge">NetConf.Name</code> attribute) is <strong>not</strong> supported.</li>
</ul>

<h3 id="routed---layer-3---topology">Routed - layer 3 - topology</h3>
<p>This topology is a simplification of the topology for the cluster default
network - but without egress.</p>

<p>There is a logical switch per node - each with a different subnet - and a
router interconnecting all the logical switches.</p>

<p>The following net-attach-def configures the attachment to a routed secondary
network.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">k8s.cni.cncf.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkAttachmentDefinition</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">l3-network</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ns1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|2</span>
    <span class="s">{</span>
            <span class="s">"cniVersion": "0.3.1",</span>
            <span class="s">"name": "l3-network",</span>
            <span class="s">"type": "ovn-k8s-cni-overlay",</span>
            <span class="s">"topology":"layer3",</span>
            <span class="s">"subnets": "10.128.0.0/16/24",</span>
            <span class="s">"mtu": 1300,</span>
            <span class="s">"netAttachDefName": "ns1/l3-network"</span>
    <span class="s">}</span>
</code></pre></div></div>

<h4 id="network-configuration-reference">Network Configuration reference</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">name</code> (string, required): the name of the network. This attribute is <strong>not</strong> namespaced.</li>
  <li><code class="language-plaintext highlighter-rouge">type</code> (string, required): “ovn-k8s-cni-overlay”.</li>
  <li><code class="language-plaintext highlighter-rouge">topology</code> (string, required): “layer3”.</li>
  <li><code class="language-plaintext highlighter-rouge">subnets</code> (string, required): a comma separated list of subnets. When multiple subnets
are provided, the user will get an IP from each subnet.</li>
  <li><code class="language-plaintext highlighter-rouge">mtu</code> (integer, optional): explicitly set MTU to the specified value. Defaults to the value chosen by the kernel.</li>
  <li><code class="language-plaintext highlighter-rouge">netAttachDefName</code> (string, required): must match <code class="language-plaintext highlighter-rouge">&lt;namespace&gt;/&lt;net-attach-def name&gt;</code>
of the surrounding object.</li>
</ul>

<p><strong>NOTE</strong></p>
<ul>
  <li>the <code class="language-plaintext highlighter-rouge">subnets</code> attribute indicates both the subnet across the cluster, and per node.
The example above means you have a /16 subnet for the network, but each <strong>node</strong> has
a /24 subnet.</li>
  <li>routed - layer3 - topology networks <strong>only</strong> allow for east/west traffic.</li>
</ul>

<h3 id="switched---layer-2---topology">Switched - layer 2 - topology</h3>
<p>This topology interconnects the workloads via a cluster-wide logical switch.</p>

<p>The following net-attach-def configures the attachment to a layer 2 secondary
network.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">k8s.cni.cncf.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkAttachmentDefinition</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">l2-network</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ns1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|2</span>
    <span class="s">{</span>
            <span class="s">"cniVersion": "0.3.1",</span>
            <span class="s">"name": "l2-network",</span>
            <span class="s">"type": "ovn-k8s-cni-overlay",</span>
            <span class="s">"topology":"layer2",</span>
            <span class="s">"subnets": "10.100.200.0/24",</span>
            <span class="s">"mtu": 1300,</span>
            <span class="s">"netAttachDefName": "ns1/l2-network",</span>
            <span class="s">"excludeSubnets": "10.100.200.0/29"</span>
    <span class="s">}</span>
</code></pre></div></div>

<h4 id="network-configuration-reference-1">Network Configuration reference</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">name</code> (string, required): the name of the network. This attribute is <strong>not</strong> namespaced.</li>
  <li><code class="language-plaintext highlighter-rouge">type</code> (string, required): “ovn-k8s-cni-overlay”.</li>
  <li><code class="language-plaintext highlighter-rouge">topology</code> (string, required): “layer2”.</li>
  <li><code class="language-plaintext highlighter-rouge">subnets</code> (string, optional): a comma separated list of subnets. When multiple subnets
are provided, the user will get an IP from each subnet.</li>
  <li><code class="language-plaintext highlighter-rouge">mtu</code> (integer, optional): explicitly set MTU to the specified value. Defaults to the value chosen by the kernel.</li>
  <li><code class="language-plaintext highlighter-rouge">netAttachDefName</code> (string, required): must match <code class="language-plaintext highlighter-rouge">&lt;namespace&gt;/&lt;net-attach-def name&gt;</code>
of the surrounding object.</li>
  <li><code class="language-plaintext highlighter-rouge">excludeSubnets</code> (string, optional): a comma separated list of CIDRs / IPs.
These IPs will be removed from the assignable IP pool, and never handed over
to the pods.</li>
</ul>

<p><strong>NOTE</strong></p>
<ul>
  <li>when the subnets attribute is omitted, the logical switch implementing the
network will only provide layer 2 communication, and the users must configure
IPs for the pods. Port security will only prevent MAC spoofing.</li>
  <li>switched - layer2 - secondary networks <strong>only</strong> allow for east/west traffic.</li>
</ul>

<h3 id="switched---localnet---topology">Switched - localnet - topology</h3>
<p>This topology interconnects the workloads via a cluster-wide logical switch to
a physical network.</p>

<p>The following net-attach-def configures the attachment to a localnet secondary
network.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">k8s.cni.cncf.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkAttachmentDefinition</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">localnet-network</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ns1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">|2</span>
    <span class="s">{</span>
            <span class="s">"cniVersion": "0.3.1",</span>
            <span class="s">"name": "localnet-network",</span>
            <span class="s">"type": "ovn-k8s-cni-overlay",</span>
            <span class="s">"topology":"localnet",</span>
            <span class="s">"subnets": "202.10.130.112/28",</span>
            <span class="s">"vlanID": 33,</span>
            <span class="s">"mtu": 1500,</span>
            <span class="s">"netAttachDefName": "ns1/localnet-network"</span>
    <span class="s">}</span>
</code></pre></div></div>

<p>Note that in order to connect to the physical network, it is expected that
ovn-bridge-mappings is configured appropriately on the chassis for this
localnet network.</p>

<h4 id="network-configuration-reference-2">Network Configuration reference</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">name</code> (string, required): the name of the network.</li>
  <li><code class="language-plaintext highlighter-rouge">type</code> (string, required): “ovn-k8s-cni-overlay”.</li>
  <li><code class="language-plaintext highlighter-rouge">topology</code> (string, required): “localnet”.</li>
  <li><code class="language-plaintext highlighter-rouge">subnets</code> (string, optional): a comma separated list of subnets. When multiple subnets
are provided, the user will get an IP from each subnet.</li>
  <li><code class="language-plaintext highlighter-rouge">mtu</code> (integer, optional): explicitly set MTU to the specified value. Defaults to the value chosen by the kernel.</li>
  <li><code class="language-plaintext highlighter-rouge">netAttachDefName</code> (string, required): must match <code class="language-plaintext highlighter-rouge">&lt;namespace&gt;/&lt;net-attach-def name&gt;</code>
of the surrounding object.</li>
  <li><code class="language-plaintext highlighter-rouge">excludeSubnets</code> (string, optional): a comma separated list of CIDRs / IPs.
These IPs will be removed from the assignable IP pool, and never handed over
to the pods.</li>
  <li><code class="language-plaintext highlighter-rouge">vlanID</code> (integer, optional): assign VLAN tag. Defaults to none.</li>
</ul>

<p><strong>NOTE</strong></p>
<ul>
  <li>when the subnets attribute is omitted, the logical switch implementing the
network will only provide layer 2 communication, and the users must configure
IPs for the pods. Port security will only prevent MAC spoofing.</li>
</ul>

<h2 id="pod-configuration">Pod configuration</h2>
<p>The user must specify the secondary network attachments via the
<code class="language-plaintext highlighter-rouge">k8s.v1.cni.cncf.io/networks</code> annotation.</p>

<p>The following example provisions a pod with two secondary attachments, one for
each of the attachment configurations presented in
<a href="#configuring-secondary-networks">Configuring secondary networks</a>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">k8s.v1.cni.cncf.io/networks</span><span class="pi">:</span> <span class="s">l3-network,l2-network</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">tinypod</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ns1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">pause</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">registry.k8s.io/e2e-test-images/agnhost:2.36</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">agnhost-container</span>
</code></pre></div></div>

<h3 id="setting-static-ip-addresses-on-a-pod">Setting static IP addresses on a pod</h3>
<p>The user can specify attachment parameters via
<a href="https://github.com/k8snetworkplumbingwg/network-attachment-definition-client/blob/63033d5c63d1cf56f924a5454c8f2ac444b6736d/pkg/apis/k8s.cni.cncf.io/v1/types.go#L137">network-selection-elements</a>
, namely IP, MAC, and interface name.</p>

<p>Refer to the following yaml for an example on how to request a static IP for a
pod, a MAC address, and specify the pod interface name.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">k8s.v1.cni.cncf.io/networks</span><span class="pi">:</span> <span class="s1">'</span><span class="s">[</span>
      <span class="s">{</span>
        <span class="s">"name":</span><span class="nv"> </span><span class="s">"l2-network",</span>
        <span class="s">"mac":</span><span class="nv"> </span><span class="s">"02:03:04:05:06:07",</span>
        <span class="s">"interface":</span><span class="nv"> </span><span class="s">"myiface1",</span>
        <span class="s">"ips":</span><span class="nv"> </span><span class="s">[</span>
          <span class="s">"192.0.2.20/24"</span>
        <span class="s">]</span>
      <span class="s">}</span>
    <span class="s">]'</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">tinypod</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ns1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">pause</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">registry.k8s.io/e2e-test-images/agnhost:2.36</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">agnhost-container</span>
</code></pre></div></div>

<p><strong>NOTE:</strong></p>
<ul>
  <li>the user can specify the IP address for a pod’s secondary attachment
<strong>only</strong> for an L2 or localnet attachment.</li>
  <li>specifying a static IP address for the pod is only possible when the
attachment configuration does <strong>not</strong> feature subnets.</li>
</ul>

<h2 id="multi-network-policies">Multi-network Policies</h2>
<p>OVN-Kubernetes implements native support for
<a href="https://github.com/k8snetworkplumbingwg/multi-networkpolicy">multi-networkpolicy</a>,
an API providing
<a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">network policy</a>
features for secondary networks.</p>

<p>To configure pod isolation, the user must:</p>
<ul>
  <li>provision a <code class="language-plaintext highlighter-rouge">network-attachment-definition</code>.</li>
  <li>provision a <code class="language-plaintext highlighter-rouge">MultiNetworkPolicy</code> indicating to which secondary networks it
applies via the
<a href="https://github.com/k8snetworkplumbingwg/multi-networkpolicy#policy-for-annotation">policy-for</a>
annotation.</li>
</ul>

<p><strong>NOTE:</strong> the <code class="language-plaintext highlighter-rouge">OVN_MULTI_NETWORK_ENABLE</code> config flag must be enabled.</p>

<p>Please refer to the following example:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">k8s.cni.cncf.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkAttachmentDefinition</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">tenant-blue</span>
<span class="na">spec</span><span class="pi">:</span>
    <span class="na">config</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{</span>
        <span class="s">"cniVersion":</span><span class="nv"> </span><span class="s">"0.4.0",</span>
        <span class="s">"name":</span><span class="nv"> </span><span class="s">"tenant-blue",</span>
        <span class="s">"netAttachDefName":</span><span class="nv"> </span><span class="s">"default/tenant-blue",</span>
        <span class="s">"topology":</span><span class="nv"> </span><span class="s">"layer2",</span>
        <span class="s">"type":</span><span class="nv"> </span><span class="s">"ovn-k8s-cni-overlay",</span>
        <span class="s">"subnets":</span><span class="nv"> </span><span class="s">"192.168.100.0/24"</span>
    <span class="s">}'</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">k8s.cni.cncf.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">MultiNetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">k8s.v1.cni.cncf.io/policy-for</span><span class="pi">:</span> <span class="s">default/tenant-blue</span> <span class="c1"># indicates the net-attach-defs this policy applies to</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">allow-ports-same-ns</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">stuff-doer</span> <span class="c1"># the policy will **apply** to all pods with this label</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">9000</span>
      <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">from</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">namespaceSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">role</span><span class="pi">:</span> <span class="s">trusted</span> <span class="c1"># only pods on namespaces with this label will be allowed on port 9000</span>
  <span class="na">policyTypes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">Ingress</span>
</code></pre></div></div>

<p>Please note the <code class="language-plaintext highlighter-rouge">MultiNetworkPolicy</code> has the <strong>exact same</strong> API of the native
<code class="language-plaintext highlighter-rouge">networking.k8s.io/v1</code> <code class="language-plaintext highlighter-rouge">NetworkPolicy</code>object; check its documentation for more
information.</p>

<p><strong>Note:</strong> <code class="language-plaintext highlighter-rouge">net-attach-def</code>s referred to by the <code class="language-plaintext highlighter-rouge">k8s.v1.cni.cncf.io/policy-for</code>
annotation without the subnet attribute defined are possible if the policy
<strong>only features</strong> <code class="language-plaintext highlighter-rouge">ipBlock</code> peers. If the <code class="language-plaintext highlighter-rouge">net-attach-def</code> features the
<code class="language-plaintext highlighter-rouge">subnet</code> attribute, it can also feature <code class="language-plaintext highlighter-rouge">namespaceSelectors</code> and <code class="language-plaintext highlighter-rouge">podSelectors</code>.</p>

<h2 id="limitations">Limitations</h2>
<p>OVN-K currently does <strong>not</strong> support:</p>
<ul>
  <li>the same attachment configured multiple times in the same pod - i.e.
<code class="language-plaintext highlighter-rouge">k8s.v1.cni.cncf.io/networks: l3-network,l3-network</code> is invalid.</li>
  <li>updates to the network selection elements lists - i.e. <code class="language-plaintext highlighter-rouge">k8s.v1.cni.cncf.io/networks</code> annotation</li>
</ul>

        </section>

        <aside id="sidebar">
          

          
            <p class="repo-owner"><a href="https://github.com/ovn-org/ovn-kubernetes">ovn-kubernetes</a> is maintained by <a href="https://github.com/ovn-org">ovn-org</a>.</p>
          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

  </body>
</html>
