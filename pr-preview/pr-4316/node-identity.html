<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/ovn-kubernetes/assets/css/style.css?v=9e6c62f21184b23c5bdbecd995abe5f149115b0f" media="screen" type="text/css">
    <link rel="stylesheet" href="/ovn-kubernetes/assets/css/print.css" media="print" type="text/css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>OVN-Kubernetes Node Identity | OVN-Kubernetes Homepage</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="OVN-Kubernetes Node Identity" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="test" />
<meta property="og:description" content="test" />
<link rel="canonical" href="http://www.ovn.org/ovn-kubernetes/node-identity.html" />
<meta property="og:url" content="http://www.ovn.org/ovn-kubernetes/node-identity.html" />
<meta property="og:site_name" content="OVN-Kubernetes Homepage" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="OVN-Kubernetes Node Identity" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"test","headline":"OVN-Kubernetes Node Identity","url":"http://www.ovn.org/ovn-kubernetes/node-identity.html"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/ovn-kubernetes/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="http://www.ovn.org/ovn-kubernetes/">
          <h1>OVN-Kubernetes Homepage</h1>
        </a>
        <h2>test</h2>
        
          <a href="https://github.com/ovn-org/ovn-kubernetes" class="button"><small>View project on</small> GitHub</a>
        
        
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1 id="ovn-kubernetes-node-identity">OVN-Kubernetes Node Identity</h1>

<h2 id="introduction">Introduction</h2>

<p>The OVN-Kubernetes node identity feature introduces a per-node client certificate for ovnkube-node pods,
together with a <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook">validating admission webhook</a>, 
enabling granular permission enforcement specific to ovn-kubernetes.
Previously, all <code class="language-plaintext highlighter-rouge">ovnkube-node</code> pods shared a common service account, 
with their API permissions managed only through Kubernetes <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">RBAC</a> rules.<br />
The goal of this feature is to limit <code class="language-plaintext highlighter-rouge">ovnkube-node</code> permissions to the minimum required for networking management on a specific Kubernetes node.
We will mimic the <a href="https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/">approach used by kubelet</a> in which every node has a unique identity, 
and its API write requests are verified using a <a href="https://github.com/kubernetes/kubernetes/blob/9e0569f2ed3934060fabe51be4e15232bbea3877/plugin/pkg/admission/noderestriction/admission.go">NodeRestriction</a> validating admission webhook.</p>

<h2 id="per-node-client-certificates">Per-node client certificates</h2>

<p>This process mimics the <a href="https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/#bootstrap-initialization">bootstrap initialization</a> in kubelet.
When the <code class="language-plaintext highlighter-rouge">ovnkube-node</code> starts for the first time, it uses the host’s <code class="language-plaintext highlighter-rouge">kubeconfig</code> to create a <a href="https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/">CertificateSigningRequest</a>
that requests a client certificate for the <code class="language-plaintext highlighter-rouge">system:ovn-node:&lt;nodeName&gt;</code> user in the <code class="language-plaintext highlighter-rouge">system:ovn-nodes</code> group.
This request is then signed by the <a href="https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#kubernetes-signers">kubernetes.io/kube-apiserver-client</a> signer.</p>

<p>For the certificate to be signed, it must first be approved.
The newly introduced <code class="language-plaintext highlighter-rouge">OVNKubeCSRController</code> component approves or denies <code class="language-plaintext highlighter-rouge">CertificateSigningRequests</code> created for users with the <code class="language-plaintext highlighter-rouge">system:ovn-node</code> prefix.
The <code class="language-plaintext highlighter-rouge">OVNKubeCSRController</code> performs several checks to validate the requested certificate, including:</p>
<ul>
  <li>Ensuring that the node name extracted from the request matches the node name of the user that sent it.</li>
  <li>Verifying that the group is set to <code class="language-plaintext highlighter-rouge">system:ovn-nodes</code>.</li>
  <li>Checking that the certificate expiration does not exceed the maximum allowed duration.</li>
</ul>

<p>Once the certificate is approved and signed, <code class="language-plaintext highlighter-rouge">ovnkube-node</code> uses it to communicate with the API server and request a new certificate upon expiration.
The RBAC rules are consistent across all <code class="language-plaintext highlighter-rouge">ovnkube-node</code> pods, we use the <code class="language-plaintext highlighter-rouge">system:ovn-nodes</code> group as the subject for Role/ClusterRole bindings to avoid duplication:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">ovnkube-node</span>
<span class="na">roleRef</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">ovnkube-node</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
    <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
<span class="na">subjects</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">system:ovn-nodes</span>
      <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>
<p>Note: By default, the generated certificates have a brief lifetime set (10min).
This is intentional as it helps ensure that the certificate rotation works seamlessly, but it might be adjusted in production environments.</p>

<h2 id="validating-admission-webhook">Validating Admission Webhook</h2>

<p>The feature introduces a validating webhook for updates to <code class="language-plaintext highlighter-rouge">pod/status</code> (Interconnect only) and <code class="language-plaintext highlighter-rouge">node/status</code>.<br />
The <code class="language-plaintext highlighter-rouge">ovnkube-node</code> pod exclusively updates the status on both resources, so it is sufficient to verify only update requests.<br />
The webhooks include the following checks for each <code class="language-plaintext highlighter-rouge">ovnkube-node</code> pod:</p>
<ul>
  <li>Modifying annotations on pods hosted on its own node.</li>
  <li>Modifying annotations on its own node.</li>
  <li>Modifying only allowed annotations.</li>
  <li>Not modifying anything other than annotations.</li>
</ul>

<p>The allowed annotations list contains both common and feature specific values:</p>
<ul>
  <li>By default, the webhook will verify a set of common node annotations used in all deployments.</li>
  <li>When <code class="language-plaintext highlighter-rouge">enable-interconnect</code> parameter is provided the webhook will validate additional pod/node annotations set by the ovnkube-node component in interconnect environments.</li>
  <li>When <code class="language-plaintext highlighter-rouge">enable-hybrid-overlay</code> parameter is provided the webhook will validate additional node annotations set by the ovnkube-node component in interconnect environments.</li>
</ul>

<p>The specific annotation values can be found in <code class="language-plaintext highlighter-rouge">go-controller/pkg/ovnwebhook/nodeadmission.go</code> and <code class="language-plaintext highlighter-rouge">go-controller/pkg/ovnwebhook/podadmission.go</code> files.</p>

<p>Some of the allowed annotations have additional checks; for instance, the IP addresses in <a href="https://github.com/ovn-org/ovn-kubernetes/blob/5d56a53df520a085e629cdc71be092afed9c3f0f/go-controller/pkg/util/pod_annotation.go#L20-L51">k8s.ovn.org/pod-networks</a>
must match the node’s <a href="https://github.com/ovn-org/ovn-kubernetes/blob/5d56a53df520a085e629cdc71be092afed9c3f0f/go-controller/pkg/util/subnet_annotations.go#L15-L39">k8s.ovn.org/node-subnets</a> networks.</p>

<h2 id="deployment">Deployment</h2>

<p>In Kind,
the feature is enabled by default and can be disabled with <code class="language-plaintext highlighter-rouge">--disable-ovnkube-identity</code> when creating the cluster.<br />
By default,
the webhook listens on the nodes <code class="language-plaintext highlighter-rouge">localhost</code> address so there has to be an instance running on the control-plane node:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pod -lname=ovnkube-identity -n ovn-kubernetes  -o wide
NAME                                READY   STATUS    RESTARTS   AGE   IP           NODE                NOMINATED NODE   READINESS GATES
ovnkube-identity-57f9778d99-llfqz   1/1     Running   0          30m   172.18.0.3   ovn-control-plane   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>
<p>This approach allows us to collocate the webhook with the API server for better response times
and avoid relying on cluster networking.</p>

        </section>

        <aside id="sidebar">
          

          
            <p class="repo-owner"><a href="https://github.com/ovn-org/ovn-kubernetes">ovn-kubernetes</a> is maintained by <a href="https://github.com/ovn-org">ovn-org</a>.</p>
          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

  </body>
</html>
